/**
 * skylark-data-files - The skylark file system library
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-paths","../base-provider","../../stats","../../file-type","../../file-error","../../error-codes","../../file-flag","../../action-type","./overlay-file"],function(e,t,i,s,r,n,h,a,l){const c="/.deletedFiles.log";function o(e){return 146|e}function d(e){return h.getFileFlag(e)}return class extends t{constructor(e,t){if(super(),this._isInitialized=!1,this._initializeCallbacks=[],this._deletedFiles={},this._deleteLog="",this._deleteLogUpdatePending=!1,this._deleteLogUpdateNeeded=!1,this._deleteLogError=null,this._writable=e,this._readable=t,this._writable.isReadOnly())throw new r(n.EINVAL,"Writable file system must be writable.")}static isAvailable(){return!0}getOverlayedProviders(){return{readable:this._readable,writable:this._writable}}_syncAsync(e,t){this.createParentDirectoriesAsync(e.getPath(),i=>{if(i)return t(i);this._writable.writeFile(e.getPath(),e.getBuffer(),null,d("w"),e.getStats().mode,t)})}_syncSync(e){this.createParentDirectories(e.getPath()),this._writable.writeFileSync(e.getPath(),e.getBuffer(),null,d("w"),e.getStats().mode)}getName(){return OverlayFS.Name}_initialize(e){const t=this._initializeCallbacks,i=e=>{this._isInitialized=!e,this._initializeCallbacks=[],t.forEach(t=>t(e))};if(this._isInitialized)return e();t.push(e),1===t.length&&this._writable.readFile(c,"utf8",d("r"),(e,t)=>{if(e){if(e.errno!==n.ENOENT)return i(e)}else this._deleteLog=t;this._reparseDeletionLog(),i()})}isReadOnly(){return!1}supportsSynch(){return this._readable.supportsSynch()&&this._writable.supportsSynch()}supportsLinks(){return!1}supportsProps(){return this._readable.supportsProps()&&this._writable.supportsProps()}getDeletionLog(){return this._deleteLog}restoreDeletionLog(e){this._deleteLog=e,this._reparseDeletionLog(),this.updateLog("")}rename(t,i,s){if(this.checkInitAsync(s)&&!this.checkPathAsync(t,s)&&!this.checkPathAsync(i,s))return t===c||i===c?s(r.EPERM("Cannot rename deletion log.")):t===i?s():void this.stat(t,!1,(h,a)=>h?s(h):this.stat(i,!1,(h,l)=>{const c=this;function o(r){const n=r.shift();if(!n)return s();const h=e.resolve(t,n),a=e.resolve(i,n);c.rename(h,a,e=>{if(e)return s(e);o(r)})}let u=511;if(a.isDirectory()){if(h)return h.errno!==n.ENOENT?s(h):this._writable.exists(t,e=>{if(e)return this._writable.rename(t,i,s);this._writable.mkdir(i,u,e=>{if(e)return s(e);this._readable.readdir(t,(e,t)=>{if(e)return s();o(t)})})});if(u=l.mode,!l.isDirectory())return s(r.ENOTDIR(i));this.readdir(i,(e,n)=>{if(n&&n.length)return s(r.ENOTEMPTY(i));this._readable.readdir(t,(e,t)=>{if(e)return s();o(t)})})}if(l&&l.isDirectory())return s(r.EISDIR(i));this.readFile(t,null,d("r"),(e,r)=>e?s(e):this.writeFile(i,r,null,d("w"),a.mode,e=>e?s(e):this.unlink(t,s)))}))}renameSync(t,i){if(this.checkInitialized(),this.checkPath(t),this.checkPath(i),t===c||i===c)throw r.EPERM("Cannot rename deletion log.");const s=this.statSync(t,!1);if(s.isDirectory()){if(t===i)return;let s=511;if(this.existsSync(i)){const e=this.statSync(i,!1);if(s=e.mode,!e.isDirectory())throw r.ENOTDIR(i);if(this.readdirSync(i).length>0)throw r.ENOTEMPTY(i)}this._writable.existsSync(t)?this._writable.renameSync(t,i):this._writable.existsSync(i)||this._writable.mkdirSync(i,s),this._readable.existsSync(t)&&this._readable.readdirSync(t).forEach(s=>{this.renameSync(e.resolve(t,s),e.resolve(i,s))})}else{if(this.existsSync(i)&&this.statSync(i,!1).isDirectory())throw r.EISDIR(i);this.writeFileSync(i,this.readFileSync(t,null,d("r")),null,d("w"),s.mode)}t!==i&&this.existsSync(t)&&this.unlinkSync(t)}stat(e,t,s){this.checkInitAsync(s)&&this._writable.stat(e,t,(h,a)=>{h&&h.errno===n.ENOENT?(this._deletedFiles[e]&&s(r.ENOENT(e)),this._readable.stat(e,t,(e,t)=>{t&&((t=i.clone(t)).mode=o(t.mode)),s(e,t)})):s(h,a)})}statSync(e,t){this.checkInitialized();try{return this._writable.statSync(e,t)}catch(s){if(this._deletedFiles[e])throw r.ENOENT(e);const n=i.clone(this._readable.statSync(e,t));return n.mode=o(n.mode),n}}open(e,t,s,n){this.checkInitAsync(n)&&!this.checkPathAsync(e,n)&&this.stat(e,!1,(h,c)=>{if(c)switch(t.pathExistsAction()){case a.TRUNCATE_FILE:return this.createParentDirectoriesAsync(e,i=>{if(i)return n(i);this._writable.open(e,t,s,n)});case a.NOP:return this._writable.exists(e,r=>{r?this._writable.open(e,t,s,n):((c=i.clone(c)).mode=s,this._readable.readFile(e,null,d("r"),(i,s)=>{if(i)return n(i);-1===c.size&&(c.size=s.length);const r=new l(this,e,t,c,s);n(null,r)}))});default:return n(r.EEXIST(e))}else switch(t.pathNotExistsAction()){case a.CREATE_FILE:return this.createParentDirectoriesAsync(e,i=>i?n(i):this._writable.open(e,t,s,n));default:return n(r.ENOENT(e))}})}openSync(e,t,s){if(this.checkInitialized(),this.checkPath(e),e===c)throw r.EPERM("Cannot open deletion log.");if(this.existsSync(e))switch(t.pathExistsAction()){case a.TRUNCATE_FILE:return this.createParentDirectories(e),this._writable.openSync(e,t,s);case a.NOP:if(this._writable.existsSync(e))return this._writable.openSync(e,t,s);{const r=this._readable.readFileSync(e,null,d("r")),n=i.clone(this._readable.statSync(e,!1));return n.mode=s,new l(this,e,t,n,r)}default:throw r.EEXIST(e)}else switch(t.pathNotExistsAction()){case a.CREATE_FILE:return this.createParentDirectories(e),this._writable.openSync(e,t,s);default:throw r.ENOENT(e)}}unlink(e,t){this.checkInitAsync(t)&&!this.checkPathAsync(e,t)&&this.exists(e,i=>{if(!i)return t(r.ENOENT(e));this._writable.exists(e,i=>{if(i)return this._writable.unlink(e,i=>{if(i)return t(i);this.exists(e,i=>{i&&this.deletePath(e),t(null)})});this.deletePath(e),t(null)})})}unlinkSync(e){if(this.checkInitialized(),this.checkPath(e),!this.existsSync(e))throw r.ENOENT(e);this._writable.existsSync(e)&&this._writable.unlinkSync(e),this.existsSync(e)&&this.deletePath(e)}rmdir(e,t){if(!this.checkInitAsync(t))return;const i=()=>{this.readdir(e,(i,s)=>i?t(i):s.length?t(r.ENOTEMPTY(e)):(this.deletePath(e),void t(null)))};this.exists(e,s=>{if(!s)return t(r.ENOENT(e));this._writable.exists(e,s=>{s?this._writable.rmdir(e,s=>{if(s)return t(s);this._readable.exists(e,e=>{e?i():t()})}):i()})})}rmdirSync(e){if(this.checkInitialized(),!this.existsSync(e))throw r.ENOENT(e);if(this._writable.existsSync(e)&&this._writable.rmdirSync(e),this.existsSync(e)){if(this.readdirSync(e).length>0)throw r.ENOTEMPTY(e);this.deletePath(e)}}mkdir(e,t,i){this.checkInitAsync(i)&&this.exists(e,s=>{if(s)return i(r.EEXIST(e));this.createParentDirectoriesAsync(e,s=>{if(s)return i(s);this._writable.mkdir(e,t,i)})})}mkdirSync(e,t){if(this.checkInitialized(),this.existsSync(e))throw r.EEXIST(e);this.createParentDirectories(e),this._writable.mkdirSync(e,t)}readdir(e,t){this.checkInitAsync(t)&&this.stat(e,!1,(i,s)=>i?t(i):s.isDirectory()?void this._writable.readdir(e,(i,s)=>{if(i&&"ENOENT"!==i.code)return t(i);!i&&s||(s=[]),this._readable.readdir(e,(i,r)=>{!i&&r||(r=[]);const n={},h=s.concat(r.filter(t=>!this._deletedFiles[`${e}/${t}`])).filter(e=>{const t=!n[e];return n[e]=!0,t});t(null,h)})}):t(r.ENOTDIR(e)))}readdirSync(e){if(this.checkInitialized(),!this.statSync(e,!1).isDirectory())throw r.ENOTDIR(e);let t=[];try{t=t.concat(this._writable.readdirSync(e))}catch(e){}try{t=t.concat(this._readable.readdirSync(e).filter(t=>!this._deletedFiles[`${e}/${t}`]))}catch(e){}const i={};return t.filter(e=>{const t=!i[e];return i[e]=!0,t})}exists(e,t){this.checkInitialized(),this._writable.exists(e,i=>{if(i)return t(!0);this._readable.exists(e,i=>{t(i&&!0!==this._deletedFiles[e])})})}existsSync(e){return this.checkInitialized(),this._writable.existsSync(e)||this._readable.existsSync(e)&&!0!==this._deletedFiles[e]}chmod(e,t,i,s){this.checkInitAsync(s)&&this.operateOnWritableAsync(e,r=>{if(r)return s(r);this._writable.chmod(e,t,i,s)})}chmodSync(e,t,i){this.checkInitialized(),this.operateOnWritable(e,()=>{this._writable.chmodSync(e,t,i)})}chown(e,t,i,s,r){this.checkInitAsync(r)&&this.operateOnWritableAsync(e,n=>{if(n)return r(n);this._writable.chown(e,t,i,s,r)})}chownSync(e,t,i,s){this.checkInitialized(),this.operateOnWritable(e,()=>{this._writable.chownSync(e,t,i,s)})}utimes(e,t,i,s){this.checkInitAsync(s)&&this.operateOnWritableAsync(e,r=>{if(r)return s(r);this._writable.utimes(e,t,i,s)})}utimesSync(e,t,i){this.checkInitialized(),this.operateOnWritable(e,()=>{this._writable.utimesSync(e,t,i)})}deletePath(e){this._deletedFiles[e]=!0,this.updateLog(`d${e}\n`)}updateLog(e){this._deleteLog+=e,this._deleteLogUpdatePending?this._deleteLogUpdateNeeded=!0:(this._deleteLogUpdatePending=!0,this._writable.writeFile(c,this._deleteLog,"utf8",h.getFileFlag("w"),420,e=>{this._deleteLogUpdatePending=!1,e?this._deleteLogError=e:this._deleteLogUpdateNeeded&&(this._deleteLogUpdateNeeded=!1,this.updateLog(""))}))}_reparseDeletionLog(){this._deletedFiles={},this._deleteLog.split("\n").forEach(e=>{this._deletedFiles[e.slice(1)]="d"===e.slice(0,1)})}checkInitialized(){if(!this._isInitialized)throw new r(n.EPERM,"OverlayProvideris not initialized. Please initialize OverlayProviderusing its initialize() method before using it.");if(null!==this._deleteLogError){const e=this._deleteLogError;throw this._deleteLogError=null,e}}checkInitAsync(e){if(!this._isInitialized)return e(new r(n.EPERM,"OverlayProvideris not initialized. Please initialize OverlayProviderusing its initialize() method before using it.")),!1;if(null!==this._deleteLogError){const t=this._deleteLogError;return this._deleteLogError=null,e(t),!1}return!0}checkPath(e){if(e===c)throw r.EPERM(e)}checkPathAsync(e,t){return e===c&&(t(r.EPERM(e)),!0)}createParentDirectoriesAsync(t,i){let s=e.dirname(t);const h=[],a=this;this._writable.stat(s,!1,function t(l,c){l?"/"===s?i(new r(n.EBUSY,"Invariant failed: root does not exist!")):(h.push(s),s=e.dirname(s),a._writable.stat(s,!1,t)):function e(){if(!h.length)return i();const t=h.pop();a._readable.stat(t,!1,(s,r)=>{if(!r)return i();a._writable.mkdir(t,r.mode,t=>{if(t)return i(t);e()})})}()})}createParentDirectories(t){let i=e.dirname(t),s=[];for(;!this._writable.existsSync(i);)s.push(i),i=e.dirname(i);(s=s.reverse()).forEach(e=>{this._writable.mkdirSync(e,this.statSync(e,!1).mode)})}operateOnWritable(e,t){if(!this.existsSync(e))throw r.ENOENT(e);this._writable.existsSync(e)||this.copyToWritable(e),t()}operateOnWritableAsync(e,t){this.exists(e,i=>{if(!i)return t(r.ENOENT(e));this._writable.exists(e,i=>{if(!i)return this.copyToWritableAsync(e,t);t()})})}copyToWritable(e){const t=this.statSync(e,!1);t.isDirectory()?this._writable.mkdirSync(e,t.mode):this.writeFileSync(e,this._readable.readFileSync(e,null,d("r")),null,d("w"),this.statSync(e,!1).mode)}copyToWritableAsync(e,t){this.stat(e,!1,(i,s)=>i?t(i):s.isDirectory()?this._writable.mkdir(e,s.mode,t):void this._readable.readFile(e,null,d("r"),(i,r)=>{if(i)return t(i);this.writeFile(e,r,null,d("w"),s.mode,t)}))}}});
//# sourceMappingURL=../../sourcemaps/providers/overlay/unlocked-overlay-provider.js.map
