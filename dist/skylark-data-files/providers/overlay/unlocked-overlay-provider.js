/**
 * skylark-data-files - The skylark file system library
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-paths","../base-provider","../../stats","../../file-type","../../file-error","../../error-codes","../../file-flag","../../action-type","./overlay-file"],function(e,t,i,r,s,n,h,a,l){const c="/.deletedFiles.log";function o(e){return 146|e}function d(e){return h.getFileFlag(e)}return class extends t{constructor(e,t){if(super(),this._isInitialized=!1,this._initializeCallbacks=[],this._deletedFiles={},this._deleteLog="",this._deleteLogUpdatePending=!1,this._deleteLogUpdateNeeded=!1,this._deleteLogError=null,this._writable=e,this._readable=t,this._writable.isReadOnly())throw new ApiError(ErrorCode.EINVAL,"Writable file system must be writable.")}static isAvailable(){return!0}getOverlayedProviders(){return{readable:this._readable,writable:this._writable}}_syncAsync(e,t){this.createParentDirectoriesAsync(e.getPath(),i=>{if(i)return t(i);this._writable.writeFile(e.getPath(),e.getBuffer(),null,d("w"),e.getStats().mode,t)})}_syncSync(e){this.createParentDirectories(e.getPath()),this._writable.writeFileSync(e.getPath(),e.getBuffer(),null,d("w"),e.getStats().mode)}getName(){return OverlayFS.Name}_initialize(e){const t=this._initializeCallbacks,i=e=>{this._isInitialized=!e,this._initializeCallbacks=[],t.forEach(t=>t(e))};if(this._isInitialized)return e();t.push(e),1===t.length&&this._writable.readFile(c,"utf8",d("r"),(e,t)=>{if(e){if(e.errno!==ErrorCode.ENOENT)return i(e)}else this._deleteLog=t;this._reparseDeletionLog(),i()})}isReadOnly(){return!1}supportsSynch(){return this._readable.supportsSynch()&&this._writable.supportsSynch()}supportsLinks(){return!1}supportsProps(){return this._readable.supportsProps()&&this._writable.supportsProps()}getDeletionLog(){return this._deleteLog}restoreDeletionLog(e){this._deleteLog=e,this._reparseDeletionLog(),this.updateLog("")}rename(t,i,r){if(this.checkInitAsync(r)&&!this.checkPathAsync(t,r)&&!this.checkPathAsync(i,r))return t===c||i===c?r(ApiError.EPERM("Cannot rename deletion log.")):t===i?r():void this.stat(t,!1,(s,n)=>s?r(s):this.stat(i,!1,(s,h)=>{const a=this;function l(s){const n=s.shift();if(!n)return r();const h=e.resolve(t,n),c=e.resolve(i,n);a.rename(h,c,e=>{if(e)return r(e);l(s)})}let c=511;if(n.isDirectory()){if(s)return s.errno!==ErrorCode.ENOENT?r(s):this._writable.exists(t,e=>{if(e)return this._writable.rename(t,i,r);this._writable.mkdir(i,c,e=>{if(e)return r(e);this._readable.readdir(t,(e,t)=>{if(e)return r();l(t)})})});if(c=h.mode,!h.isDirectory())return r(ApiError.ENOTDIR(i));this.readdir(i,(e,s)=>{if(s&&s.length)return r(ApiError.ENOTEMPTY(i));this._readable.readdir(t,(e,t)=>{if(e)return r();l(t)})})}if(h&&h.isDirectory())return r(ApiError.EISDIR(i));this.readFile(t,null,d("r"),(e,s)=>e?r(e):this.writeFile(i,s,null,d("w"),n.mode,e=>e?r(e):this.unlink(t,r)))}))}renameSync(t,i){if(this.checkInitialized(),this.checkPath(t),this.checkPath(i),t===c||i===c)throw ApiError.EPERM("Cannot rename deletion log.");const r=this.statSync(t,!1);if(r.isDirectory()){if(t===i)return;let r=511;if(this.existsSync(i)){const e=this.statSync(i,!1);if(r=e.mode,!e.isDirectory())throw ApiError.ENOTDIR(i);if(this.readdirSync(i).length>0)throw ApiError.ENOTEMPTY(i)}this._writable.existsSync(t)?this._writable.renameSync(t,i):this._writable.existsSync(i)||this._writable.mkdirSync(i,r),this._readable.existsSync(t)&&this._readable.readdirSync(t).forEach(r=>{this.renameSync(e.resolve(t,r),e.resolve(i,r))})}else{if(this.existsSync(i)&&this.statSync(i,!1).isDirectory())throw ApiError.EISDIR(i);this.writeFileSync(i,this.readFileSync(t,null,d("r")),null,d("w"),r.mode)}t!==i&&this.existsSync(t)&&this.unlinkSync(t)}stat(e,t,r){this.checkInitAsync(r)&&this._writable.stat(e,t,(s,n)=>{s&&s.errno===ErrorCode.ENOENT?(this._deletedFiles[e]&&r(ApiError.ENOENT(e)),this._readable.stat(e,t,(e,t)=>{t&&((t=i.clone(t)).mode=o(t.mode)),r(e,t)})):r(s,n)})}statSync(e,t){this.checkInitialized();try{return this._writable.statSync(e,t)}catch(r){if(this._deletedFiles[e])throw ApiError.ENOENT(e);const s=i.clone(this._readable.statSync(e,t));return s.mode=o(s.mode),s}}open(e,t,r,s){this.checkInitAsync(s)&&!this.checkPathAsync(e,s)&&this.stat(e,!1,(n,h)=>{if(h)switch(t.pathExistsAction()){case a.TRUNCATE_FILE:return this.createParentDirectoriesAsync(e,i=>{if(i)return s(i);this._writable.open(e,t,r,s)});case a.NOP:return this._writable.exists(e,n=>{n?this._writable.open(e,t,r,s):((h=i.clone(h)).mode=r,this._readable.readFile(e,null,d("r"),(i,r)=>{if(i)return s(i);-1===h.size&&(h.size=r.length);const n=new l(this,e,t,h,r);s(null,n)}))});default:return s(ApiError.EEXIST(e))}else switch(t.pathNotExistsAction()){case a.CREATE_FILE:return this.createParentDirectoriesAsync(e,i=>i?s(i):this._writable.open(e,t,r,s));default:return s(ApiError.ENOENT(e))}})}openSync(e,t,r){if(this.checkInitialized(),this.checkPath(e),e===c)throw ApiError.EPERM("Cannot open deletion log.");if(this.existsSync(e))switch(t.pathExistsAction()){case a.TRUNCATE_FILE:return this.createParentDirectories(e),this._writable.openSync(e,t,r);case a.NOP:if(this._writable.existsSync(e))return this._writable.openSync(e,t,r);{const s=this._readable.readFileSync(e,null,d("r")),n=i.clone(this._readable.statSync(e,!1));return n.mode=r,new l(this,e,t,n,s)}default:throw ApiError.EEXIST(e)}else switch(t.pathNotExistsAction()){case a.CREATE_FILE:return this.createParentDirectories(e),this._writable.openSync(e,t,r);default:throw ApiError.ENOENT(e)}}unlink(e,t){this.checkInitAsync(t)&&!this.checkPathAsync(e,t)&&this.exists(e,i=>{if(!i)return t(ApiError.ENOENT(e));this._writable.exists(e,i=>{if(i)return this._writable.unlink(e,i=>{if(i)return t(i);this.exists(e,i=>{i&&this.deletePath(e),t(null)})});this.deletePath(e),t(null)})})}unlinkSync(e){if(this.checkInitialized(),this.checkPath(e),!this.existsSync(e))throw ApiError.ENOENT(e);this._writable.existsSync(e)&&this._writable.unlinkSync(e),this.existsSync(e)&&this.deletePath(e)}rmdir(e,t){if(!this.checkInitAsync(t))return;const i=()=>{this.readdir(e,(i,r)=>i?t(i):r.length?t(ApiError.ENOTEMPTY(e)):(this.deletePath(e),void t(null)))};this.exists(e,r=>{if(!r)return t(ApiError.ENOENT(e));this._writable.exists(e,r=>{r?this._writable.rmdir(e,r=>{if(r)return t(r);this._readable.exists(e,e=>{e?i():t()})}):i()})})}rmdirSync(e){if(this.checkInitialized(),!this.existsSync(e))throw ApiError.ENOENT(e);if(this._writable.existsSync(e)&&this._writable.rmdirSync(e),this.existsSync(e)){if(this.readdirSync(e).length>0)throw ApiError.ENOTEMPTY(e);this.deletePath(e)}}mkdir(e,t,i){this.checkInitAsync(i)&&this.exists(e,r=>{if(r)return i(ApiError.EEXIST(e));this.createParentDirectoriesAsync(e,r=>{if(r)return i(r);this._writable.mkdir(e,t,i)})})}mkdirSync(e,t){if(this.checkInitialized(),this.existsSync(e))throw ApiError.EEXIST(e);this.createParentDirectories(e),this._writable.mkdirSync(e,t)}readdir(e,t){this.checkInitAsync(t)&&this.stat(e,!1,(i,r)=>i?t(i):r.isDirectory()?void this._writable.readdir(e,(i,r)=>{if(i&&"ENOENT"!==i.code)return t(i);!i&&r||(r=[]),this._readable.readdir(e,(i,s)=>{!i&&s||(s=[]);const n={},h=r.concat(s.filter(t=>!this._deletedFiles[`${e}/${t}`])).filter(e=>{const t=!n[e];return n[e]=!0,t});t(null,h)})}):t(ApiError.ENOTDIR(e)))}readdirSync(e){if(this.checkInitialized(),!this.statSync(e,!1).isDirectory())throw ApiError.ENOTDIR(e);let t=[];try{t=t.concat(this._writable.readdirSync(e))}catch(e){}try{t=t.concat(this._readable.readdirSync(e).filter(t=>!this._deletedFiles[`${e}/${t}`]))}catch(e){}const i={};return t.filter(e=>{const t=!i[e];return i[e]=!0,t})}exists(e,t){this.checkInitialized(),this._writable.exists(e,i=>{if(i)return t(!0);this._readable.exists(e,i=>{t(i&&!0!==this._deletedFiles[e])})})}existsSync(e){return this.checkInitialized(),this._writable.existsSync(e)||this._readable.existsSync(e)&&!0!==this._deletedFiles[e]}chmod(e,t,i,r){this.checkInitAsync(r)&&this.operateOnWritableAsync(e,s=>{if(s)return r(s);this._writable.chmod(e,t,i,r)})}chmodSync(e,t,i){this.checkInitialized(),this.operateOnWritable(e,()=>{this._writable.chmodSync(e,t,i)})}chown(e,t,i,r,s){this.checkInitAsync(s)&&this.operateOnWritableAsync(e,n=>{if(n)return s(n);this._writable.chown(e,t,i,r,s)})}chownSync(e,t,i,r){this.checkInitialized(),this.operateOnWritable(e,()=>{this._writable.chownSync(e,t,i,r)})}utimes(e,t,i,r){this.checkInitAsync(r)&&this.operateOnWritableAsync(e,s=>{if(s)return r(s);this._writable.utimes(e,t,i,r)})}utimesSync(e,t,i){this.checkInitialized(),this.operateOnWritable(e,()=>{this._writable.utimesSync(e,t,i)})}deletePath(e){this._deletedFiles[e]=!0,this.updateLog(`d${e}\n`)}updateLog(e){this._deleteLog+=e,this._deleteLogUpdatePending?this._deleteLogUpdateNeeded=!0:(this._deleteLogUpdatePending=!0,this._writable.writeFile(c,this._deleteLog,"utf8",h.getFileFlag("w"),420,e=>{this._deleteLogUpdatePending=!1,e?this._deleteLogError=e:this._deleteLogUpdateNeeded&&(this._deleteLogUpdateNeeded=!1,this.updateLog(""))}))}_reparseDeletionLog(){this._deletedFiles={},this._deleteLog.split("\n").forEach(e=>{this._deletedFiles[e.slice(1)]="d"===e.slice(0,1)})}checkInitialized(){if(!this._isInitialized)throw new ApiError(ErrorCode.EPERM,"OverlayProvideris not initialized. Please initialize OverlayProviderusing its initialize() method before using it.");if(null!==this._deleteLogError){const e=this._deleteLogError;throw this._deleteLogError=null,e}}checkInitAsync(e){if(!this._isInitialized)return e(new ApiError(ErrorCode.EPERM,"OverlayProvideris not initialized. Please initialize OverlayProviderusing its initialize() method before using it.")),!1;if(null!==this._deleteLogError){const t=this._deleteLogError;return this._deleteLogError=null,e(t),!1}return!0}checkPath(e){if(e===c)throw ApiError.EPERM(e)}checkPathAsync(e,t){return e===c&&(t(ApiError.EPERM(e)),!0)}createParentDirectoriesAsync(t,i){let r=e.dirname(t);const s=[],n=this;this._writable.stat(r,!1,function t(h,a){h?"/"===r?i(new ApiError(ErrorCode.EBUSY,"Invariant failed: root does not exist!")):(s.push(r),r=e.dirname(r),n._writable.stat(r,!1,t)):function e(){if(!s.length)return i();const t=s.pop();n._readable.stat(t,!1,(r,s)=>{if(!s)return i();n._writable.mkdir(t,s.mode,t=>{if(t)return i(t);e()})})}()})}createParentDirectories(t){let i=e.dirname(t),r=[];for(;!this._writable.existsSync(i);)r.push(i),i=e.dirname(i);(r=r.reverse()).forEach(e=>{this._writable.mkdirSync(e,this.statSync(e,!1).mode)})}operateOnWritable(e,t){if(!this.existsSync(e))throw ApiError.ENOENT(e);this._writable.existsSync(e)||this.copyToWritable(e),t()}operateOnWritableAsync(e,t){this.exists(e,i=>{if(!i)return t(ApiError.ENOENT(e));this._writable.exists(e,i=>{if(!i)return this.copyToWritableAsync(e,t);t()})})}copyToWritable(e){const t=this.statSync(e,!1);t.isDirectory()?this._writable.mkdirSync(e,t.mode):this.writeFileSync(e,this._readable.readFileSync(e,null,d("r")),null,d("w"),this.statSync(e,!1).mode)}copyToWritableAsync(e,t){this.stat(e,!1,(i,r)=>i?t(i):r.isDirectory()?this._writable.mkdir(e,r.mode,t):void this._readable.readFile(e,null,d("r"),(i,s)=>{if(i)return t(i);this.writeFile(e,s,null,d("w"),r.mode,t)}))}}});
//# sourceMappingURL=../../sourcemaps/providers/overlay/unlocked-overlay-provider.js.map
