/**
 * skylark-data-files - The skylark file system library
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-string/generate-uuid","skylark-langx-binary/buffer","skylark-langx-paths","skylark-data-collections/lru-cache","../files","../error-codes","../file-error","../file-type","../utils","../inodes/inode","./base-provider","./async-key-value-file"],function(t,e,i,n,s,r,o,a,c,d,l,h){"use strict";const{emptyBuffer:m}=c,f="/";let u=null;function N(t,e){return!t||(e(t),!1)}function g(t,e,i){return!t||(e.abort(()=>{i(t)}),!1)}return class extends l{constructor(t){super(),this._cache=null,t>0&&(this._cache=new n(t))}static isAvailable(){return!0}init(t,e){this.store=t,this.makeRootDirectory(e)}getName(){return this.store.name()}isReadOnly(){return!1}supportsSymlinks(){return!1}supportsProps(){return!1}supportsSynch(){return!1}empty(t){this._cache&&this._cache.removeAll(),this.store.clear(e=>{N(e,t)&&this.makeRootDirectory(t)})}rename(t,n,s){if(this._cache){const t=this._cache;this._cache=null,t.removeAll();const e=s;s=(i=>{this._cache=t,e(i)})}const a=this.store.beginTransaction("readwrite"),c=i.dirname(t),d=i.basename(t),l=i.dirname(n),h=i.basename(n),m={},f={};let u=!1;if(0===(l+"/").indexOf(t+"/"))return s(new o(r.EBUSY,c));const N=()=>{if(u||!f.hasOwnProperty(c)||!f.hasOwnProperty(l))return;const i=f[c],r=m[c],N=f[l],y=m[l];if(i[d]){const t=i[d];delete i[d];const m=()=>{N[h]=t,a.put(r.id,e.from(JSON.stringify(i)),!0,t=>{g(t,a,s)&&(c===l?a.commit(s):a.put(y.id,e.from(JSON.stringify(N)),!0,t=>{g(t,a,s)&&a.commit(s)}))})};N[h]?this.getINode(a,n,N[h],(t,e)=>{g(t,a,s)&&(e.isFile()?a.del(e.id,t=>{g(t,a,s)&&a.del(N[h],t=>{g(t,a,s)&&m()})}):a.abort(t=>{s(o.EPERM(n))}))}):m()}else s(o.ENOENT(t))},y=t=>{this.findINodeAndDirListing(a,t,(e,i,n)=>{e?u||(u=!0,a.abort(()=>{s(e)})):(m[t]=i,f[t]=n,N())})};y(c),c!==l&&y(l)}stat(t,e,i){const n=this.store.beginTransaction("readonly");this.findINode(n,t,(t,e)=>{N(t,i)&&i(null,e.toStats())})}createFile(t,e,i,n){const s=this.store.beginTransaction("readwrite"),r=m();this.commitNewFile(s,t,a.FILE,i,r,(i,s)=>{N(i,n)&&n(null,new h(this,t,e,s.toStats(),r))})}openFile(t,e,i){const n=this.store.beginTransaction("readonly");this.findINode(n,t,(s,r)=>{N(s,i)&&n.get(r.id,(n,s)=>{N(n,i)&&(void 0===s?i(o.ENOENT(t)):i(null,new h(this,t,e,r.toStats(),s)))})})}unlink(t,e){this.removeEntry(t,!1,e)}rmdir(t,e){this.readdir(t,(i,n)=>{i?e(i):n.length>0?e(o.ENOTEMPTY(t)):this.removeEntry(t,!0,e)})}mkdir(t,i,n){const s=this.store.beginTransaction("readwrite"),r=e.from("{}");this.commitNewFile(s,t,a.DIRECTORY,i,r,n)}readdir(t,e){const i=this.store.beginTransaction("readonly");this.findINode(i,t,(n,s)=>{N(n,e)&&this.getDirListing(i,t,s,(t,i)=>{N(t,e)&&e(null,Object.keys(i))})})}_sync(t,e,n,s){const r=this.store.beginTransaction("readwrite");this._findINode(r,i.dirname(t),i.basename(t),(i,o)=>{g(i,r,s)&&this.getINode(r,t,o,(t,i)=>{if(g(t,r,s)){const t=i.update(n);r.put(i.id,e,!0,e=>{g(e,r,s)&&(t?r.put(o,i.toBuffer(),!0,t=>{g(t,r,s)&&r.commit(s)}):r.commit(s))})}})})}makeRootDirectory(i){const n=this.store.beginTransaction("readwrite");n.get(f,(s,r)=>{if(s||void 0===r){const s=(new Date).getTime(),r=new d(t(),4096,511|a.DIRECTORY,s,s,s);n.put(r.id,u||(u=e.from("{}")),!1,t=>{g(t,n,i)&&n.put(f,r.toBuffer(),!1,t=>{t?n.abort(()=>{i(t)}):n.commit(i)})})}else n.commit(i)})}_findINode(t,e,n,s){if(this._cache){const t=this._cache.get(i.join(e,n));if(t)return s(null,t)}const r=(t,r,a)=>{if(t)s(t);else if(a[n]){const t=a[n];this._cache&&this._cache.set(i.join(e,n),t),s(null,t)}else s(o.ENOENT(i.resolve(e,n)))};"/"===e?""===n?(this._cache&&this._cache.set(i.join(e,n),f),s(null,f)):this.getINode(t,e,f,(i,n)=>{N(i,s)&&this.getDirListing(t,e,n,(t,e)=>{r(t,0,e)})}):this.findINodeAndDirListing(t,e,r)}findINode(t,e,n){this._findINode(t,i.dirname(e),i.basename(e),(i,s)=>{N(i,n)&&this.getINode(t,e,s,n)})}getINode(t,e,i,n){t.get(i,(t,i)=>{N(t,n)&&(void 0===i?n(o.ENOENT(e)):n(null,d.fromBuffer(i)))})}getDirListing(t,e,i,n){i.isDirectory()?t.get(i.id,(t,i)=>{if(N(t,n))try{n(null,JSON.parse(i.toString()))}catch(t){n(o.ENOENT(e))}}):n(o.ENOTDIR(e))}findINodeAndDirListing(t,e,i){this.findINode(t,e,(n,s)=>{N(n,i)&&this.getDirListing(t,e,s,(t,e)=>{N(t,i)&&i(null,s,e)})})}addNewNode(e,i,n){let s,a=0;const c=()=>{5==++a?n(new o(r.EIO,"Unable to commit data to key-value store.")):(s=t(),e.put(s,i,!1,(t,e)=>{t||!e?c():n(null,s)}))};c()}commitNewFile(t,n,s,r,a,c){const l=i.dirname(n),h=i.basename(n),m=(new Date).getTime();if("/"===n)return c(o.EEXIST(n));this.findINodeAndDirListing(t,l,(i,l,f)=>{g(i,t,c)&&(f[h]?t.abort(()=>{c(o.EEXIST(n))}):this.addNewNode(t,a,(i,n)=>{if(g(i,t,c)){const i=new d(n,a.length,r|s,m,m,m);this.addNewNode(t,i.toBuffer(),(n,s)=>{g(n,t,c)&&(f[h]=s,t.put(l.id,e.from(JSON.stringify(f)),!0,e=>{g(e,t,c)&&t.commit(e=>{g(e,t,c)&&c(null,i)})}))})}}))})}removeEntry(t,n,s){this._cache&&this._cache.remove(t);const r=this.store.beginTransaction("readwrite"),a=i.dirname(t),c=i.basename(t);this.findINodeAndDirListing(r,a,(i,a,d)=>{if(g(i,r,s))if(d[c]){const i=d[c];delete d[c],this.getINode(r,t,i,(c,l)=>{g(c,r,s)&&(!n&&l.isDirectory()?r.abort(()=>{s(o.EISDIR(t))}):n&&!l.isDirectory()?r.abort(()=>{s(o.ENOTDIR(t))}):r.del(l.id,t=>{g(t,r,s)&&r.del(i,t=>{g(t,r,s)&&r.put(a.id,e.from(JSON.stringify(d)),!0,t=>{g(t,r,s)&&r.commit(s)})})}))})}else r.abort(()=>{s(o.ENOENT(t))})})}}});
//# sourceMappingURL=../sourcemaps/providers/async-key-value-provider.js.map
