/**
 * skylark-data-files - The skylark file system library
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-strings/generate-uuid","skylark-langx-binary/buffer","skylark-langx-paths","skylark-data-collections/lru-cache","../files","../error-codes","../file-error","../file-type","../utils","../inodes/inode","./base-provider","./async-key-value-file"],function(e,t,i,n,s,r,o,a,c,d,l,h){"use strict";const{emptyBuffer:m}=c,u="/";let f=null;function N(e,t){return!e||(t(e),!1)}function g(e,t,i){return!e||(t.abort(()=>{i(e)}),!1)}return s.providers.AsyncKeyValueProvider=class extends l{constructor(e){super(),this._cache=null,e>0&&(this._cache=new n(e))}static isAvailable(){return!0}init(e,t){this.store=e,this.makeRootDirectory(t)}getName(){return this.store.name()}isReadOnly(){return!1}supportsSymlinks(){return!1}supportsProps(){return!1}supportsSynch(){return!1}empty(e){this._cache&&this._cache.removeAll(),this.store.clear(t=>{N(t,e)&&this.makeRootDirectory(e)})}rename(e,n,s){if(this._cache){const e=this._cache;this._cache=null,e.removeAll();const t=s;s=(i=>{this._cache=e,t(i)})}const a=this.store.beginTransaction("readwrite"),c=i.dirname(e),d=i.basename(e),l=i.dirname(n),h=i.basename(n),m={},u={};let f=!1;if(0===(l+"/").indexOf(e+"/"))return s(new o(r.EBUSY,c));const N=()=>{if(f||!u.hasOwnProperty(c)||!u.hasOwnProperty(l))return;const i=u[c],r=m[c],N=u[l],y=m[l];if(i[d]){const e=i[d];delete i[d];const m=()=>{N[h]=e,a.put(r.id,t.from(JSON.stringify(i)),!0,e=>{g(e,a,s)&&(c===l?a.commit(s):a.put(y.id,t.from(JSON.stringify(N)),!0,e=>{g(e,a,s)&&a.commit(s)}))})};N[h]?this.getINode(a,n,N[h],(e,t)=>{g(e,a,s)&&(t.isFile()?a.del(t.id,e=>{g(e,a,s)&&a.del(N[h],e=>{g(e,a,s)&&m()})}):a.abort(e=>{s(o.EPERM(n))}))}):m()}else s(o.ENOENT(e))},y=e=>{this.findINodeAndDirListing(a,e,(t,i,n)=>{t?f||(f=!0,a.abort(()=>{s(t)})):(m[e]=i,u[e]=n,N())})};y(c),c!==l&&y(l)}stat(e,t,i){const n=this.store.beginTransaction("readonly");this.findINode(n,e,(e,t)=>{N(e,i)&&i(null,t.toStats())})}createFile(e,t,i,n){const s=this.store.beginTransaction("readwrite"),r=m();this.commitNewFile(s,e,a.FILE,i,r,(i,s)=>{N(i,n)&&n(null,new h(this,e,t,s.toStats(),r))})}openFile(e,t,i){const n=this.store.beginTransaction("readonly");this.findINode(n,e,(s,r)=>{N(s,i)&&n.get(r.id,(n,s)=>{N(n,i)&&(void 0===s?i(o.ENOENT(e)):i(null,new h(this,e,t,r.toStats(),s)))})})}unlink(e,t){this.removeEntry(e,!1,t)}rmdir(e,t){this.readdir(e,(i,n)=>{i?t(i):n.length>0?t(o.ENOTEMPTY(e)):this.removeEntry(e,!0,t)})}mkdir(e,i,n){const s=this.store.beginTransaction("readwrite"),r=t.from("{}");this.commitNewFile(s,e,a.DIRECTORY,i,r,n)}readdir(e,t){const i=this.store.beginTransaction("readonly");this.findINode(i,e,(n,s)=>{N(n,t)&&this.getDirListing(i,e,s,(e,i)=>{N(e,t)&&t(null,Object.keys(i))})})}_sync(e,t,n,s){const r=this.store.beginTransaction("readwrite");this._findINode(r,i.dirname(e),i.basename(e),(i,o)=>{g(i,r,s)&&this.getINode(r,e,o,(e,i)=>{if(g(e,r,s)){const e=i.update(n);r.put(i.id,t,!0,t=>{g(t,r,s)&&(e?r.put(o,i.toBuffer(),!0,e=>{g(e,r,s)&&r.commit(s)}):r.commit(s))})}})})}makeRootDirectory(i){const n=this.store.beginTransaction("readwrite");n.get(u,(s,r)=>{if(s||void 0===r){const s=(new Date).getTime(),r=new d(e(),4096,511|a.DIRECTORY,s,s,s);n.put(r.id,f||(f=t.from("{}")),!1,e=>{g(e,n,i)&&n.put(u,r.toBuffer(),!1,e=>{e?n.abort(()=>{i(e)}):n.commit(i)})})}else n.commit(i)})}_findINode(e,t,n,s){if(this._cache){const e=this._cache.get(i.join(t,n));if(e)return s(null,e)}const r=(e,r,a)=>{if(e)s(e);else if(a[n]){const e=a[n];this._cache&&this._cache.set(i.join(t,n),e),s(null,e)}else s(o.ENOENT(i.resolve(t,n)))};"/"===t?""===n?(this._cache&&this._cache.set(i.join(t,n),u),s(null,u)):this.getINode(e,t,u,(i,n)=>{N(i,s)&&this.getDirListing(e,t,n,(e,t)=>{r(e,0,t)})}):this.findINodeAndDirListing(e,t,r)}findINode(e,t,n){this._findINode(e,i.dirname(t),i.basename(t),(i,s)=>{N(i,n)&&this.getINode(e,t,s,n)})}getINode(e,t,i,n){e.get(i,(e,i)=>{N(e,n)&&(void 0===i?n(o.ENOENT(t)):n(null,d.fromBuffer(i)))})}getDirListing(e,t,i,n){i.isDirectory()?e.get(i.id,(e,i)=>{if(N(e,n))try{n(null,JSON.parse(i.toString()))}catch(e){n(o.ENOENT(t))}}):n(o.ENOTDIR(t))}findINodeAndDirListing(e,t,i){this.findINode(e,t,(n,s)=>{N(n,i)&&this.getDirListing(e,t,s,(e,t)=>{N(e,i)&&i(null,s,t)})})}addNewNode(t,i,n){let s,a=0;const c=()=>{5==++a?n(new o(r.EIO,"Unable to commit data to key-value store.")):(s=e(),t.put(s,i,!1,(e,t)=>{e||!t?c():n(null,s)}))};c()}commitNewFile(e,n,s,r,a,c){const l=i.dirname(n),h=i.basename(n),m=(new Date).getTime();if("/"===n)return c(o.EEXIST(n));this.findINodeAndDirListing(e,l,(i,l,u)=>{g(i,e,c)&&(u[h]?e.abort(()=>{c(o.EEXIST(n))}):this.addNewNode(e,a,(i,n)=>{if(g(i,e,c)){const i=new d(n,a.length,r|s,m,m,m);this.addNewNode(e,i.toBuffer(),(n,s)=>{g(n,e,c)&&(u[h]=s,e.put(l.id,t.from(JSON.stringify(u)),!0,t=>{g(t,e,c)&&e.commit(t=>{g(t,e,c)&&c(null,i)})}))})}}))})}removeEntry(e,n,s){this._cache&&this._cache.remove(e);const r=this.store.beginTransaction("readwrite"),a=i.dirname(e),c=i.basename(e);this.findINodeAndDirListing(r,a,(i,a,d)=>{if(g(i,r,s))if(d[c]){const i=d[c];delete d[c],this.getINode(r,e,i,(c,l)=>{g(c,r,s)&&(!n&&l.isDirectory()?r.abort(()=>{s(o.EISDIR(e))}):n&&!l.isDirectory()?r.abort(()=>{s(o.ENOTDIR(e))}):r.del(l.id,e=>{g(e,r,s)&&r.del(i,e=>{g(e,r,s)&&r.put(a.id,t.from(JSON.stringify(d)),!0,e=>{g(e,r,s)&&r.commit(s)})})}))})}else r.abort(()=>{s(o.ENOENT(e))})})}}});
//# sourceMappingURL=../sourcemaps/providers/async-key-value-provider.js.map
