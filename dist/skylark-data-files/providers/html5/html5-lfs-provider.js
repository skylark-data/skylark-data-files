/**
 * skylark-data-files - The skylark file system library
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-async","skylark-langx-paths","../../files","../registry","../../preload-file","../base-provider","../../error-codes","../../file-error","../../action-type","../../stats","../../file-type","../../utils","./html5-lfs-file"],function(e,r,t,i,o,s,n,a,l,c,u,d,E){"use strict";const f=e.each,{buffer2ArrayBuffer:h,arrayBuffer2Buffer:y}=d;const p=window.webkitRequestProvider||window.requestProvider||null;function w(e,r,t){switch(e.name){case"PathExistsError":return a.EEXIST(r);case"QuotaExceededError":return a.FileError(n.ENOSPC,r);case"NotFoundError":return a.ENOENT(r);case"SecurityError":return a.FileError(n.EACCES,r);case"InvalidModificationError":return a.FileError(n.EPERM,r);case"TypeMismatchError":return a.FileError(t?n.ENOTDIR:n.EISDIR,r);case"EncodingError":case"InvalidStateError":case"NoModificationAllowedError":default:return a.FileError(n.EINVAL,r)}}class m extends s{constructor(e=5,r=window.PERSISTENT){super(),this.size=1048576*e,this.type=r}static Create(e,r){const t=new m(e.size,e.type);t._allocate(e=>e?r(e):r(null,t))}static isAvailable(){return!!p}getName(){return m.Name}isReadOnly(){return!1}supportsSymlinks(){return!1}supportsProps(){return!1}supportsSynch(){return!1}empty(e){this._readdir("/",(r,t)=>{if(r)e(r);else{f(t,(e,r)=>{const t=()=>{r()},i=t=>{r(w(t,e.fullPath,!e.isDirectory))};e.isDirectory?e.removeRecursively(t,i):e.remove(t,i)},t=>{r?e(r):e()})}})}rename(e,t,i){let o=2,s=0;const l=this.fs.root;let c=e;const u=e=>{--o<=0&&i(w(e,c,!1))},d=o=>2==++s?i(new a(n.EINVAL,"Something was identified as both a file and a directory. This should never happen.")):e===t?i():(c=r.dirname(t),void l.getDirectory(c,{},s=>{c=r.basename(t),o.moveTo(s,c,e=>{i()},r=>{o.isDirectory?(c=t,this.unlink(t,o=>{o?u(r):this.rename(e,t,i)})):u(r)})},u));l.getFile(e,{},d,u),l.getDirectory(e,{},d,u)}stat(e,r,t){const i={create:!1},o=e=>{const r=new c(u.DIRECTORY,4096);t(null,r)},s=r=>{t(w(r,e,!1))};this.fs.root.getFile(e,i,e=>{e.file(e=>{const r=new c(u.FILE,e.size);t(null,r)},s)},()=>{this.fs.root.getDirectory(e,i,o,s)})}open(e,r,t,i){const o=t=>{"InvalidModificationError"===t.name&&r.isExclusive()?i(a.EEXIST(e)):i(w(t,e,!1))};this.fs.root.getFile(e,{create:r.pathNotExistsAction()===l.CREATE_FILE,exclusive:r.isExclusive()},t=>{t.file(s=>{const n=new FileReader;n.onloadend=(o=>{const a=this._makeFile(e,t,r,s,n.result);i(null,a)}),n.onerror=(e=>{o(n.error)}),n.readAsArrayBuffer(s)},o)},o)}unlink(e,r){this._remove(e,r,!0)}rmdir(e,r){this.readdir(e,(t,i)=>{t?r(t):i.length>0?r(a.ENOTEMPTY(e)):this._remove(e,r,!1)})}mkdir(e,r,t){this.fs.root.getDirectory(e,{create:!0,exclusive:!0},e=>{t()},r=>{t(w(r,e,!0))})}readdir(e,r){this._readdir(e,(e,t)=>{if(!t)return r(e);{const e=[];for(const r of t)e.push(r.name);r(null,e)}})}_makeFile(e,r,t,i,o=new ArrayBuffer(0)){const s=new c(u.FILE,i.size),n=y(o);return new E(this,r,e,t,s,n)}_readdir(e,r){const t=t=>{r(w(t,e,!0))};var i;this.fs.root.getDirectory(e,{create:!1},e=>{const o=e.createReader();let s=[];const n=()=>{o.readEntries(e=>{e.length?(s=s.concat((i=e,Array.prototype.slice.call(i||[],0))),n()):r(null,s)},t)};n()},t)}_allocate(e){const r=r=>{this.fs=r,e()},t=r=>{e(w(r,"/",!0))};this.type===window.PERSISTENT?function(e,r,t,i){if(void 0!==navigator.webkitPersistentStorage)switch(e){case window.PERSISTENT:navigator.webkitPersistentStorage.requestQuota(r,t,i);break;case window.TEMPORARY:navigator.webkitTemporaryStorage.requestQuota(r,t,i);break;default:i(new TypeError(`Invalid storage type: ${e}`))}else window.webkitStorageInfo.requestQuota(e,r,t,i)}(this.type,this.size,e=>{p(this.type,e,r,t)},t):p(this.type,this.size,r,t)}_remove(e,r,t){const i=i=>{i.remove(()=>{r()},i=>{r(w(i,e,!t))})},o=i=>{r(w(i,e,!t))},s={create:!1};t?this.fs.root.getFile(e,s,i,o):this.fs.root.getDirectory(e,s,i,o)}}return m.Name="Html5LfsProvider",m.Options={size:{type:"number",optional:!0,description:"Storage quota to request, in megabytes. Allocated value may be less. Defaults to 5."},type:{type:"number",optional:!0,description:"window.PERSISTENT or window.TEMPORARY. Defaults to PERSISTENT."}},m.Html5LfsFile=E,i.add("html5Lfs",m),m});
//# sourceMappingURL=../../sourcemaps/providers/html5/html5-lfs-provider.js.map
