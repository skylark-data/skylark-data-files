/**
 * skylark-data-files - The skylark file system library
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-funcs/defer","skylark-langx-binary/buffer","skylark-langx-paths","../../files","../registry","../base-provider","../../stats","../../file-type","../../file-error","../../error-codes","../../utils","./dropbox-file"],function(e,t,r,a,s,n,o,i,c,l,h,u){"use strict";const{arrayBuffer2Buffer:f,buffer2ArrayBuffer:p}=h,{dirname:d}=r;function _(e){return"/"===e?"":e}function w(e){const t=e.error;if(t[".tag"])return t;if(t.error){const e=t.error;return e[".tag"]?e:e.reason&&e.reason[".tag"]?e.reason:e}if("string"==typeof t)try{const r=JSON.parse(t);if(r.error&&r.error.reason&&r.error.reason[".tag"])return r.error.reason}catch(e){}return t}function m(e){if(e.user_message)return e.user_message.text;if(e.error_summary)return e.error_summary;if("string"==typeof e.error)return e.error;if("object"==typeof e.error)return m(e.error);throw new Error(`Dropbox's servers gave us a garbage error message: ${JSON.stringify(e)}`)}function b(e,t,r){switch(e[".tag"]){case"malformed_path":return new c(l.EBADF,r,t);case"not_found":return c.ENOENT(t);case"not_file":return c.EISDIR(t);case"not_folder":return c.ENOTDIR(t);case"restricted_content":return c.EPERM(t);case"other":default:return new c(l.EIO,r,t)}}function E(e,t,r){switch(e[".tag"]){case"malformed_path":case"disallowed_name":return new c(l.EBADF,r,t);case"conflict":case"no_write_permission":case"team_folder":return c.EPERM(t);case"insufficient_space":return new c(l.ENOSPC,r);case"other":default:return new c(l.EIO,r,t)}}function y(e,t,r){const a={path:_(t)};e.filesDeleteV2(a).then(()=>{r()}).catch(a=>{const s=w(a);switch(s[".tag"]){case"path_lookup":r(b(s.path_lookup,t,m(a)));break;case"path_write":r(E(s.path_write,t,m(a)));break;case"too_many_write_operations":setTimeout(()=>y(e,t,r),500+300*Math.random());break;case"other":default:r(new c(l.EIO,m(a),t))}})}class g extends n{constructor(e){super(),this._client=e}static Create(e,t){t(null,new g(e.client))}static isAvailable(){return"undefined"!=typeof Dropbox}getName(){return g.Name}isReadOnly(){return!1}supportsSymlinks(){return!1}supportsProps(){return!1}supportsSynch(){return!1}empty(e){this.readdir("/",(t,r)=>{if(r){const t=a=>{0===r.length?e():y(this._client,r.shift(),t)};t()}else e(t)})}rename(e,t,r){this.stat(t,!1,(a,s)=>{const n=()=>{const a={from_path:_(e),to_path:_(t)};this._client.filesMoveV2(a).then(()=>r()).catch(function(a){const s=w(a);switch(s[".tag"]){case"from_lookup":r(b(s.from_lookup,e,m(a)));break;case"from_write":r(E(s.from_write,e,m(a)));break;case"to":r(E(s.to,t,m(a)));break;case"cant_copy_shared_folder":case"cant_nest_shared_folder":r(new c(l.EPERM,m(a),e));break;case"cant_move_folder_into_itself":case"duplicated_or_nested_paths":r(new c(l.EBADF,m(a),e));break;case"too_many_files":r(new c(l.ENOSPC,m(a),e));break;case"other":default:r(new c(l.EIO,m(a),e))}})};a?n():e===t?a?r(c.ENOENT(t)):r():s&&s.isDirectory()?r(c.EISDIR(t)):this.unlink(t,e=>{e?r(e):n()})})}stat(t,r,a){if("/"===t)return void e(function(){a(null,new o(i.DIRECTORY,4096))});const s={path:_(t)};this._client.filesGetMetadata(s).then(e=>{switch(e[".tag"]){case"file":const r=e;a(null,new o(i.FILE,r.size));break;case"folder":a(null,new o(i.DIRECTORY,4096));break;case"deleted":a(c.ENOENT(t))}}).catch(e=>{const r=w(e);switch(r[".tag"]){case"path":a(b(r.path,t,m(e)));break;default:a(new c(l.EIO,m(e),t))}})}openFile(e,t,r){const a={path:_(e)};this._client.filesDownload(a).then(a=>{const s=a.fileBlob,n=new FileReader;n.onload=(()=>{const a=n.result;r(null,new u(this,e,t,new o(i.FILE,a.byteLength),f(a)))}),n.readAsArrayBuffer(s)}).catch(t=>{const a=w(t);switch(a[".tag"]){case"path":r(b(a.path,e,m(t)));break;case"other":default:r(new c(l.EIO,m(t),e))}})}createFile(e,r,a,s){const n=t.alloc(0),h={contents:new Blob([p(n)],{type:"octet/stream"}),path:_(e)};this._client.filesUpload(h).then(t=>{s(null,new u(this,e,r,new o(i.FILE,0),n))}).catch(t=>{const n=w(t);switch(n[".tag"]){case"path":s(E(n.path.reason,e,m(t)));break;case"too_many_write_operations":setTimeout(()=>this.createFile(e,r,a,s),500+300*Math.random());break;case"other":default:s(new c(l.EIO,m(t),e))}})}unlink(e,t){this.stat(e,!1,(r,a)=>{a?a.isDirectory()?t(c.EISDIR(e)):y(this._client,e,t):t(r)})}rmdir(e,t){this.readdir(e,(r,a)=>{a?a.length>0?t(c.ENOTEMPTY(e)):y(this._client,e,t):t(r)})}mkdir(e,t,r){const a=d(e);this.stat(a,!1,(s,n)=>{if(s)r(s);else if(n&&!n.isDirectory())r(c.ENOTDIR(a));else{const a={path:_(e)};this._client.filesCreateFolderV2(a).then(()=>r()).catch(a=>{"too_many_write_operations"===w(a)[".tag"]?setTimeout(()=>this.mkdir(e,t,r),500+300*Math.random()):r(E(w(a).path,e,m(a)))})}})}readdir(e,t){const r={path:_(e)};this._client.filesListFolder(r).then(r=>{!function e(t,r,a,s,n){const o=a.entries.map(e=>e.path_display).filter(e=>!!e);const i=s.concat(o);if(a.has_more){const s={cursor:a.cursor};t.filesListFolderContinue(s).then(a=>{e(t,r,a,i,n)}).catch(e=>{k(e,r,n)})}else n(null,i)}(this._client,e,r,[],t)}).catch(r=>{k(r,e,t)})}_syncFile(e,t,r){const a={contents:new Blob([p(t)],{type:"octet/stream"}),path:_(e),mode:{".tag":"overwrite"}};this._client.filesUpload(a).then(()=>{r()}).catch(a=>{const s=w(a);switch(s[".tag"]){case"path":r(E(s.path.reason,e,m(a)));break;case"too_many_write_operations":setTimeout(()=>this._syncFile(e,t,r),500+300*Math.random());break;case"other":default:r(new c(l.EIO,m(a),e))}})}}function k(e,t,r){const a=w(e);switch(a[".tag"]){case"path":r(b(a.path,t,m(e)));break;case"other":default:r(new c(l.EIO,m(e),t))}}return g.Name="DropboxV2",g.Options={client:{type:"object",description:"An *authenticated* Dropbox client. Must be from the 2.5.x JS SDK."}},g.DropboxFile=u,s.add("dropbox",g),a.providers.DropboxProvider=g});
//# sourceMappingURL=../../sourcemaps/providers/dropbox/dropbox-provider.js.map
