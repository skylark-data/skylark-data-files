/**
 * skylark-data-files - The skylark file system library
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-strings/generate-uuid","skylark-langx-binary/buffer","skylark-langx-paths","../files","../error-codes","../file-error","./base-provider","./synchronous-provider","../utils"],function(t,e,i,r,n,o,s,a,d){"use strict";const{emptyBuffer:c}=d;return r.providers.SyncKeyValueProvider=class extends a{static isAvailable(){return!0}constructor(t){super(),this.store=t.store,this.makeRootDirectory()}getName(){return this.store.name()}isReadOnly(){return!1}supportsSymlinks(){return!1}supportsProps(){return!1}supportsSynch(){return!0}empty(){this.store.clear(),this.makeRootDirectory()}renameSync(t,r){const s=this.store.beginTransaction("readwrite"),a=i.dirname(t),d=i.basename(t),c=i.dirname(r),h=i.basename(r),f=this.findINode(s,a),m=this.getDirListing(s,a,f);if(!m[d])throw o.ENOENT(t);const y=m[d];if(delete m[d],0===(c+"/").indexOf(t+"/"))throw new o(n.EBUSY,a);let N,g;if(c===a?(N=f,g=m):(N=this.findINode(s,c),g=this.getDirListing(s,c,N)),g[h]){const t=this.getINode(s,r,g[h]);if(!t.isFile())throw o.EPERM(r);try{s.del(t.id),s.del(g[h])}catch(t){throw s.abort(),t}}g[h]=y;try{s.put(f.id,e.from(JSON.stringify(m)),!0),s.put(N.id,e.from(JSON.stringify(g)),!0)}catch(t){throw s.abort(),t}s.commit()}statSync(t,e){return this.findINode(this.store.beginTransaction("readonly"),t).toStats()}createFileSync(t,e,i){const r=this.store.beginTransaction("readwrite"),n=c(),o=this.commitNewFile(r,t,FileType.FILE,i,n);return new SyncKeyValueFile(this,t,e,o.toStats(),n)}openFileSync(t,e){const i=this.store.beginTransaction("readonly"),r=this.findINode(i,t),n=i.get(r.id);if(void 0===n)throw o.ENOENT(t);return new SyncKeyValueFile(this,t,e,r.toStats(),n)}unlinkSync(t){this.removeEntry(t,!1)}rmdirSync(t){if(this.readdirSync(t).length>0)throw o.ENOTEMPTY(t);this.removeEntry(t,!0)}mkdirSync(t,i){const r=this.store.beginTransaction("readwrite"),n=e.from("{}");this.commitNewFile(r,t,FileType.DIRECTORY,i,n)}readdirSync(t){const e=this.store.beginTransaction("readonly");return Object.keys(this.getDirListing(e,t,this.findINode(e,t)))}_syncSync(t,e,r){const n=this.store.beginTransaction("readwrite"),o=this._findINode(n,i.dirname(t),i.basename(t)),s=this.getINode(n,t,o),a=s.update(r);try{n.put(s.id,e,!0),a&&n.put(o,s.toBuffer(),!0)}catch(t){throw n.abort(),t}n.commit()}makeRootDirectory(){const e=this.store.beginTransaction("readwrite");if(void 0===e.get(ROOT_NODE_ID)){const i=(new Date).getTime(),r=new Inode(t(),4096,511|FileType.DIRECTORY,i,i,i);e.put(r.id,getEmptyDirNode(),!1),e.put(ROOT_NODE_ID,r.toBuffer(),!1),e.commit()}}_findINode(t,e,r){const n=n=>{const s=this.getDirListing(t,e,n);if(s[r])return s[r];throw o.ENOENT(i.resolve(e,r))};return"/"===e?""===r?ROOT_NODE_ID:n(this.getINode(t,e,ROOT_NODE_ID)):n(this.getINode(t,e+i.sep+r,this._findINode(t,i.dirname(e),i.basename(e))))}findINode(t,e){return this.getINode(t,e,this._findINode(t,i.dirname(e),i.basename(e)))}getINode(t,e,i){const r=t.get(i);if(void 0===r)throw o.ENOENT(e);return Inode.fromBuffer(r)}getDirListing(t,e,i){if(!i.isDirectory())throw o.ENOTDIR(e);const r=t.get(i.id);if(void 0===r)throw o.ENOENT(e);return JSON.parse(r.toString())}addNewNode(e,i){let r;for(;;)try{return r=t(),e.put(r,i,!1),r}catch(t){}throw new o(n.EIO,"Unable to commit data to key-value store.")}commitNewFile(t,r,n,s,a){const d=i.dirname(r),c=i.basename(r),h=this.findINode(t,d),f=this.getDirListing(t,d,h),m=(new Date).getTime();if("/"===r)throw o.EEXIST(r);if(f[c])throw o.EEXIST(r);let y;try{const i=this.addNewNode(t,a);y=new Inode(i,a.length,s|n,m,m,m);const r=this.addNewNode(t,y.toBuffer());f[c]=r,t.put(h.id,e.from(JSON.stringify(f)),!0)}catch(e){throw t.abort(),e}return t.commit(),y}removeEntry(t,r){const n=this.store.beginTransaction("readwrite"),s=i.dirname(t),a=this.findINode(n,s),d=this.getDirListing(n,s,a),c=i.basename(t);if(!d[c])throw o.ENOENT(t);const h=d[c];delete d[c];const f=this.getINode(n,t,h);if(!r&&f.isDirectory())throw o.EISDIR(t);if(r&&!f.isDirectory())throw o.ENOTDIR(t);try{n.del(f.id),n.del(h),n.put(a.id,e.from(JSON.stringify(d)),!0)}catch(t){throw n.abort(),t}n.commit()}}});
//# sourceMappingURL=../sourcemaps/providers/sync-key-value-provider.js.map
